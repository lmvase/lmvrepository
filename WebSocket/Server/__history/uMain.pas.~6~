unit uMain;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, System.Win.ScktComp;

type
  TForm1 = class(TForm)
    bSend: TButton;
    bStartStop: TButton;
    Memo1: TMemo;
    Edit1: TEdit;

    procedure FormCreate(Sender: TObject);
    procedure FormDestroy(Sender: TObject);
    procedure bStartStopClick(Sender: TObject);
    procedure bSendClick(Sender: TObject);
  private
    { Private declarations }
     ServerSocket: TServerSocket;
     Str: string;
  public
    { Public declarations }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

procedure TForm1.bSendClick(Sender: TObject);
var
  i: integer;
begin
     Str:=Edit1.Text;//Take the string (message) sent by the server
     Memo1.Text:=Memo1.Text+'me: '+Str+#13#10;//Adds the message to the memo box
     Edit1.Text:='';//Clears the edit box
//Sends the messages to all clients connected to the server
     for i:=0 to ServerSocket.Socket.ActiveConnections-1 do
      ServerSocket.Socket.Connections[i].SendText(str);//Sent
end;

procedure TForm1.bStartStopClick(Sender: TObject);
begin
   if(ServerSocket.Active = False)//The button caption is ‘Start’
   then
   begin
      ServerSocket.Active := True;//Activates the server socket
      Memo1.Text:=Memo1.Text+'Server Started'+#13#10;
      bStartStop.Caption:='Stop';//Set the button caption
   end
   else//The button caption is ‘Stop’
   begin
      ServerSocket.Active := False;//Stops the server socket
      Memo1.Text:=Memo1.Text+'Server Stopped'+#13#10;
      bStartStop.Caption:='Start';
     //If the server is closed, then it cannot send any messages
      bStartStop.Enabled:=false;//Disables the “Send” button
      Edit1.Enabled:=false;//Disables the edit box
   end;
end;

procedure TForm1.FormCreate(Sender: TObject);
begin
  ServerSocket := TServerSocket.Create(nil);

  ServerSocket.OnClientConnect := Conectar;
end;

procedure Conectar;
begin
  Socket.SendText('Connected');//Sends a message to the client
//If at least a client is connected to the server, then the server can communicate
//Enables the Send button and the edit box
  Button1.Enabled:=true;
  Edit1.Enabled:=true;
end;

procedure TForm1.FormDestroy(Sender: TObject);
begin
 FreeAndNil(ServerSocket);
end;

end.
